<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure DevOps - Settings</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .tools-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #edebe9;
        }

        .tool-link {
            display: block;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            text-decoration: none;
            color: #0078d4;
            transition: background 0.2s;
        }

        .tool-link:hover {
            background: #e1f3ff;
        }
    </style>
</head>
<body>
    <div class="container narrow">
        <h1>‚öôÔ∏è Azure DevOps Settings</h1>
        <p class="subtitle">Configure your Azure DevOps Server connection. Settings are shared across all tools.</p>

        <div id="currentStatus"></div>

        <form id="settingsForm">
            <div class="form-group">
                <label for="serverUrl">Azure DevOps Server URL</label>
                <div class="field-description">The base URL of your Azure DevOps Server (e.g., https://your-server.com)</div>
                <input type="text" id="serverUrl" placeholder="https://your-ado-server.com" required />
            </div>

            <div class="form-group">
                <label for="organization">Organization/Collection</label>
                <div class="field-description">Usually "DefaultCollection" for on-premise servers</div>
                <input type="text" id="organization" placeholder="DefaultCollection" required />
            </div>

            <div class="form-group">
                <label for="project">Default Project Name</label>
                <div class="field-description">Your default project (can be overridden in individual tools)</div>
                <input type="text" id="project" placeholder="MyProject" required />
            </div>

            <div class="form-group">
                <label for="repository">Default Repository Name</label>
                <div class="field-description">Your default repository (can be overridden in individual tools)</div>
                <input type="text" id="repository" placeholder="MyRepo" required />
            </div>

            <div class="form-group">
                <label for="pat">Personal Access Token (PAT)</label>
                <div class="field-description">
                    Token with "Code (Read)" permissions.
                    <a href="#" id="patHelpLink" style="color: #0078d4;">How to create a PAT?</a>
                </div>
                <input type="password" id="pat" placeholder="Your Personal Access Token" required autocomplete="off" data-lpignore="true" data-1p-ignore />
            </div>

            <div class="button-group">
                <button type="submit" class="btn-primary">üíæ Save Settings</button>
                <button type="button" class="btn-secondary" onclick="testConnection()">üîå Test Connection</button>
                <button type="button" class="btn-danger" onclick="clearSettings()">üóëÔ∏è Clear All</button>
            </div>
        </form>

        <div id="message"></div>

        <div class="warning" style="margin-top: 30px;">
            <strong>‚ö†Ô∏è Security Note:</strong> Your PAT is stored in browser localStorage.
            This is secure for localhost usage, but never use this on a public/shared computer.
        </div>

        <div class="tools-section">
            <h2>üõ†Ô∏è Available Tools</h2>
            <a href="ado-pr-threads.html" class="tool-link">
                <strong>PR Threads Viewer</strong> - View and analyze all discussion threads in a Pull Request
            </a>
        </div>

        <div id="patHelpModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Creating a Personal Access Token</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <ol style="line-height: 1.8; color: #323130; padding-left: 20px;">
                    <li>Log in to your Azure DevOps Server</li>
                    <li>Click on your profile icon (top right)</li>
                    <li>Select <strong>Security</strong></li>
                    <li>Under <strong>Personal Access Tokens</strong>, click <strong>New Token</strong></li>
                    <li>Give it a name (e.g., "ADO Tools")</li>
                    <li>Set expiration date</li>
                    <li>Under <strong>Scopes</strong>, select <strong>Code (Read)</strong></li>
                    <li>Click <strong>Create</strong></li>
                    <li>Copy the token immediately (you won't see it again!)</li>
                </ol>
                <button onclick="closeModal()" class="btn-primary" style="margin-top: 20px;">Close</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Load current settings on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            checkCurrentStatus();

            // PAT help link
            document.getElementById('patHelpLink').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('patHelpModal').classList.add('show');
            });
        });

        function closeModal() {
            document.getElementById('patHelpModal').classList.remove('show');
        }

        function loadSettings() {
            const config = ADOConfig.get();
            if (config) {
                document.getElementById('serverUrl').value = config.serverUrl || '';
                document.getElementById('organization').value = config.organization || '';
                document.getElementById('project').value = config.project || '';
                document.getElementById('repository').value = config.repository || '';
                document.getElementById('pat').value = config.pat || '';
            }
        }

        function checkCurrentStatus() {
            const config = ADOConfig.get();
            const statusDiv = document.getElementById('currentStatus');

            if (config && ADOConfig.isValid(config)) {
                statusDiv.innerHTML = `
                    <div class="info">
                        <strong>‚úì Settings configured</strong><br>
                        Server: ${ADOContent.escapeHtml(config.serverUrl)}<br>
                        Organization: ${ADOContent.escapeHtml(config.organization)}<br>
                        Project: ${ADOContent.escapeHtml(config.project)}<br>
                        PAT: ${config.pat ? '‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè (hidden)' : 'Not set'}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="warning">
                        <strong>‚ö†Ô∏è No settings found</strong><br>
                        Please configure your Azure DevOps connection below.
                    </div>
                `;
            }
        }

        document.getElementById('settingsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            saveSettings();
        });

        function saveSettings() {
            const config = ADOConfig.getFromForm({});
            ADOConfig.save(config);

            ADOUI.showMessage('message', 'success', '‚úì Settings saved successfully! You can now use any ADO tool.');
            checkCurrentStatus();

            // Auto-hide after 5 seconds
            setTimeout(() => ADOUI.clear('message'), 5000);
        }

        async function testConnection() {
            const config = ADOConfig.getFromForm({});

            if (!ADOConfig.isValid(config)) {
                ADOUI.showMessage('message', 'warning', '‚ö†Ô∏è Please fill in all required fields before testing.');
                return;
            }

            ADOUI.showMessage('message', 'info', 'üîÑ Testing connection...');

            try {
                const data = await ADOAPI.getRepositories(config);
                ADOUI.showMessage('message', 'success',
                    `‚úì Connection successful! Found ${data.count || 0} repositories in project "${ADOContent.escapeHtml(config.project)}".`);

                // Auto-hide after 5 seconds
                setTimeout(() => ADOUI.clear('message'), 5000);
            } catch (error) {
                ADOUI.showMessage('message', 'error', `‚ö†Ô∏è ${error.message}`);
            }
        }

        function clearSettings() {
            if (confirm('Are you sure you want to clear all settings? This cannot be undone.')) {
                ADOConfig.clear();
                document.getElementById('settingsForm').reset();
                ADOUI.showMessage('message', 'info', '‚ÑπÔ∏è Settings cleared.');
                checkCurrentStatus();

                // Auto-hide after 5 seconds
                setTimeout(() => ADOUI.clear('message'), 5000);
            }
        }
    </script>
</body>
</html>
