<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure DevOps PR Threads Viewer</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .pr-info {
            background: #f3f2f1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .thread-filters {
            background: #f3f2f1;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #323130;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            background: white;
        }

        .checkbox-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .status-chip {
            padding: 6px 14px;
            border: 1px solid #d1d1d1;
            border-radius: 16px;
            background: white;
            color: #323130;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .status-chip:hover {
            border-color: #0078d4;
            background: #f3f9fd;
        }

        .status-chip.selected {
            background: #0078d4;
            color: white;
            border-color: #0078d4;
        }

        .thread-container {
            margin-bottom: 30px;
        }

        .thread {
            border: 1px solid #edebe9;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .thread.compact-view .comment {
            padding: 8px 15px;
        }

        .thread.compact-view .comment-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .thread.compact-view .comment-header {
            margin-bottom: 4px;
        }

        .thread.compact-view .thread-context,
        .thread.compact-view .raw-json-container {
            display: none;
        }

        .thread.compact-view .comment-content pre,
        .thread.compact-view .comment-content code,
        .thread.compact-view .comment-content img {
            display: none;
        }

        .thread-status-change {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .thread-status-change select {
            padding: 4px 8px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }

        .thread-checkbox {
            margin-right: 10px;
        }

        .bulk-actions {
            background: #fff4ce;
            border-left: 4px solid #ffb900;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .bulk-actions-buttons select {
            padding: 8px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
        }

        .thread-header {
            background: #f3f2f1;
            padding: 10px 15px;
            font-weight: 600;
            color: #323130;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment {
            padding: 12px 15px;
            border-bottom: 1px solid #edebe9;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment.system-comment {
            background: #f8f8f8;
            border-left: 3px solid #a19f9d;
        }

        .comment.code-change-comment {
            background: #fff9e6;
            border-left: 3px solid #ffb900;
        }

        .comment-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .comment-type-system {
            background: #e1dfdd;
            color: #605e5c;
        }

        .comment-type-code-change {
            background: #fff4ce;
            color: #8a6d3b;
        }

        .comment-type-text {
            background: #e1f3ff;
            color: #004578;
        }

        .comment-type-deleted {
            background: #fde7e9;
            color: #a4262c;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #0078d4;
        }

        .comment-date {
            color: #605e5c;
            font-size: 13px;
        }

        .comment-link {
            color: #0078d4;
            text-decoration: none;
            font-size: 20px;
            margin-left: 12px;
            line-height: 1;
        }

        .comment-link:hover {
            opacity: 0.7;
        }

        .code-links {
            display: flex;
            align-items: center;
        }

        .comment-content {
            color: #323130;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .comment-content strong {
            font-weight: 700;
            color: #323130;
        }

        .comment-content em {
            font-style: italic;
            color: #323130;
        }

        .comment-content a {
            color: #0078d4;
            text-decoration: none;
        }

        .comment-content a:hover {
            text-decoration: underline;
        }

        .comment-content img {
            max-width: 100%;
            height: auto;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            margin: 5px 5px 5px 0;
            display: inline-block;
            vertical-align: middle;
        }

        .thread-context {
            background: #fff4ce;
            padding: 8px 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ffb900;
            font-size: 13px;
        }

        .file-preview {
            background: #f8f8f8;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .file-preview-header {
            padding: 8px 12px;
            background: #fff4ce;
            border-left: 3px solid #ffb900;
            cursor: pointer;
            font-size: 13px;
            color: #323130;
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-preview-header:hover {
            background: #ffecb3;
        }

        .file-preview-header span:first-child {
            color: #0078d4;
            font-weight: 600;
        }

        .file-preview-content {
            display: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-preview-content.show {
            display: block;
        }

        .file-preview-content pre {
            margin: 0;
            padding: 12px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .file-preview-line {
            display: flex;
            gap: 10px;
        }

        .file-preview-line-number {
            color: #858585;
            text-align: right;
            min-width: 40px;
            user-select: none;
        }

        .file-preview-line-content {
            flex: 1;
        }

        .file-preview-line.highlight {
            background: #264f78;
        }

        .api-link {
            color: #0078d4;
            text-decoration: none;
            font-size: 12px;
            font-family: monospace;
            background: #f3f2f1;
            padding: 4px 8px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 5px;
        }

        .api-link:hover {
            background: #e1dfdd;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>üí¨ PR Threads Viewer</h1>
                <p style="color: #605e5c; margin: 0;">View all discussion threads from a Pull Request</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="ado-pr-list.html" style="color: #0078d4; text-decoration: none; font-size: 14px;">üìã PR List</a>
                <a href="index.html" style="color: #0078d4; text-decoration: none; font-size: 14px;">üè† Home</a>
                <a href="ado-settings.html" style="color: #0078d4; text-decoration: none; font-size: 14px;">‚öôÔ∏è Settings</a>
            </div>
        </div>

        <div id="prInfo" style="margin-bottom: 20px;"></div>

        <div id="bulkActions" class="bulk-actions">
            <strong>Bulk Thread Selection Mode Active</strong>
            <p style="margin: 10px 0 0 0; font-size: 14px; color: #605e5c;">Select threads using checkboxes, then change their status below. Filters are disabled in bulk mode.</p>
            <div class="bulk-actions-buttons">
                <button onclick="selectAllThreads()" class="btn-secondary">Select All</button>
                <button onclick="deselectAllThreads()" class="btn-secondary">Deselect All</button>
                <span style="margin-left: 10px; color: #323130;">Selected: <strong id="selectedCount">0</strong> threads</span>
                <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                    <label for="bulkStatusSelect" style="margin: 0;">Change selected to:</label>
                    <select id="bulkStatusSelect">
                        <option value="">Select status...</option>
                        <option value="active">Active</option>
                        <option value="fixed">Resolved</option>
                        <option value="closed">Closed</option>
                        <option value="wontFix">Won't Fix</option>
                        <option value="pending">Pending</option>
                    </select>
                    <button onclick="applyBulkStatusChange()" class="btn-primary">Apply Changes</button>
                </div>
            </div>
        </div>

        <div id="threadFilters" class="thread-filters" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Thread Filters</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="bulkModeToggle" onclick="toggleBulkMode()" class="btn-secondary" style="padding: 8px 16px;">
                        Enable Bulk Selection
                    </button>
                    <span style="font-size: 14px; color: #605e5c;">View:</span>
                    <button id="viewToggle" onclick="toggleView()" class="btn-secondary" style="padding: 8px 16px;">
                        Switch to Compact
                    </button>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group" style="flex: 2;">
                    <label>Thread Status</label>
                    <div class="checkbox-filters">
                        <button class="status-chip selected" data-status="active" onclick="toggleStatusChip(this)">Active</button>
                        <button class="status-chip selected" data-status="fixed" onclick="toggleStatusChip(this)">Resolved</button>
                        <button class="status-chip selected" data-status="closed" onclick="toggleStatusChip(this)">Closed</button>
                        <button class="status-chip selected" data-status="wontFix" onclick="toggleStatusChip(this)">Won't Fix</button>
                        <button class="status-chip selected" data-status="pending" onclick="toggleStatusChip(this)">Pending</button>
                        <button class="status-chip" data-status="unknown" onclick="toggleStatusChip(this)">Unknown</button>
                        <button class="status-chip" data-status="noStatus" onclick="toggleStatusChip(this)">No status</button>
                    </div>
                    <div style="margin-top: 12px;">
                        <label>
                            <input type="checkbox" id="showDeleted" onchange="applyThreadFilters()">
                            Show deleted threads
                        </label>
                    </div>
                </div>

                <div class="filter-group" style="flex: 1;">
                    <label for="threadAuthorFilter">Thread Author (First Comment)</label>
                    <select id="threadAuthorFilter" onchange="applyThreadFilters()">
                        <option value="">All authors</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 15px; color: #605e5c; font-size: 13px;">
                Showing <span id="filteredCount">0</span> of <span id="totalCount">0</span> threads
            </div>
        </div>

        <div class="config-section" id="configSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Configuration</h3>
            </div>

            <details id="advancedConfig">
                <summary style="cursor: pointer; color: #0078d4; font-weight: 600;">üîß Advanced Configuration</summary>
                <div style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="serverUrl">Azure DevOps Server URL</label>
                        <input type="text" id="serverUrl" placeholder="https://your-ado-server.com" />
                    </div>
                    <div class="form-group">
                        <label for="organization">Organization/Collection</label>
                        <input type="text" id="organization" placeholder="DefaultCollection" />
                    </div>
                    <div class="form-group">
                        <label for="project">Project Name</label>
                        <input type="text" id="project" placeholder="MyProject" />
                    </div>
                    <div class="form-group">
                        <label for="repository">Repository Name</label>
                        <input type="text" id="repository" placeholder="MyRepo" />
                    </div>
                    <div class="form-group">
                        <label for="pat">Personal Access Token (PAT)</label>
                        <input type="password" id="pat" placeholder="Your PAT with Code (Read) permission" />
                    </div>
                </div>
            </details>

            <button id="loadButton" onclick="loadPRThreads()">Load PR Threads</button>
            <div id="configStatus" style="margin-top: 10px; font-size: 12px; color: #605e5c;"></div>
        </div>

        <div id="results"></div>
    </div>

    <script src="common.js"></script>
    <script>
        let currentPRId = null;
        let allThreads = [];
        let allIterations = [];
        let currentPRData = null;
        let currentConfig = null;
        let isCompactView = false;
        let isBulkMode = false;
        let selectedThreadIds = new Set();
        let isRestoringFromURL = false;

        // Parse URL parameters on load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = ADOURL.getParams();
            currentPRId = urlParams.get('prId') || urlParams.get('id');

            // Load saved configuration from localStorage
            const savedConfig = ADOConfig.get();
            if (savedConfig) {
                document.getElementById('serverUrl').value = savedConfig.serverUrl || '';
                document.getElementById('organization').value = savedConfig.organization || '';
                document.getElementById('project').value = savedConfig.project || '';
                document.getElementById('repository').value = savedConfig.repository || '';
                document.getElementById('pat').value = savedConfig.pat || '';
            }

            // Show PR info or error
            if (currentPRId) {
                showPRInfo();

                // Auto-load if config is valid
                if (savedConfig && ADOConfig.isValid(savedConfig) && savedConfig.repository) {
                    setTimeout(() => loadPRThreads(), 100);
                } else {
                    // Show config section if settings are missing
                    document.getElementById('configSection').style.display = 'block';
                    const statusDiv = document.getElementById('configStatus');
                    statusDiv.innerHTML = '‚ö†Ô∏è Some settings are missing. <a href="ado-settings.html" style="color: #0078d4;">Configure in Settings</a> or use Advanced Configuration below.';
                    statusDiv.style.color = '#8a6d3b';
                }
            } else {
                showNoPRError();
            }
        });

        function showPRInfo() {
            const prInfoDiv = document.getElementById('prInfo');
            const config = ADOConfig.get();

            prInfoDiv.innerHTML = `
                <div class="info">
                    <strong>Loading Pull Request #${currentPRId}</strong><br>
                    ${config && config.project && config.repository ?
                        `Project: ${ADOContent.escapeHtml(config.project)} / Repository: ${ADOContent.escapeHtml(config.repository)}` :
                        'Using saved configuration'}
                </div>
            `;
        }

        function showNoPRError() {
            const prInfoDiv = document.getElementById('prInfo');
            prInfoDiv.innerHTML = `
                <div class="warning">
                    <strong>‚ö†Ô∏è No Pull Request specified</strong><br>
                    Please navigate from the <a href="ado-pr-list.html" style="color: #0078d4; font-weight: 600;">PR List page</a>
                    or provide a PR ID in the URL (e.g., ?prId=123).
                </div>
            `;
        }

        // URL parameter helpers
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                prId: params.get('prId') || params.get('id') || null,
                status: params.get('status') ? params.get('status').split(',') : null,
                showDeleted: params.get('showDeleted') !== null ? params.get('showDeleted') === 'true' : null,
                author: params.get('author') || null,
                view: params.get('view') || null
            };
        }

        function updateURL() {
            if (isRestoringFromURL) return;

            const params = new URLSearchParams();

            // PR ID
            if (currentPRId) {
                params.set('prId', currentPRId);
            }

            // Thread status filters
            const selectedStatuses = getSelectedThreadStatuses();
            if (selectedStatuses.length > 0) {
                params.set('status', selectedStatuses.join(','));
            }

            // Show deleted checkbox
            const showDeleted = document.getElementById('showDeleted').checked;
            if (showDeleted) {  // Only add to URL if checked (default is unchecked)
                params.set('showDeleted', 'true');
            }

            // Author filter
            const author = document.getElementById('threadAuthorFilter').value;
            if (author) {
                params.set('author', author);
            }

            // View mode
            if (isCompactView) {  // Only add to URL if compact (default is detailed)
                params.set('view', 'compact');
            }

            const newURL = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
            history.replaceState(null, '', newURL);
        }

        function restoreFiltersFromURL() {
            const urlParams = getURLParams();
            isRestoringFromURL = true;

            try {
                // Restore status chips
                if (urlParams.status) {
                    // First deselect all status chips
                    document.querySelectorAll('.thread-filters .status-chip').forEach(chip => {
                        chip.classList.remove('selected');
                    });

                    // Then select only the ones in the URL
                    urlParams.status.forEach(status => {
                        const chip = document.querySelector(`.thread-filters .status-chip[data-status="${status}"]`);
                        if (chip) {
                            chip.classList.add('selected');
                        }
                    });
                }

                // Restore showDeleted checkbox
                if (urlParams.showDeleted !== null) {
                    document.getElementById('showDeleted').checked = urlParams.showDeleted;
                }

                // Restore author filter
                if (urlParams.author) {
                    const authorSelect = document.getElementById('threadAuthorFilter');
                    // Check if the option exists (it might not be populated yet)
                    const option = Array.from(authorSelect.options).find(opt => opt.value === urlParams.author);
                    if (option) {
                        authorSelect.value = urlParams.author;
                    }
                }

                // Restore view mode
                if (urlParams.view === 'compact' && !isCompactView) {
                    toggleView();
                }
            } finally {
                isRestoringFromURL = false;
            }

            // Apply filters to show the filtered results
            applyThreadFilters();
        }

        async function loadPRThreads() {
            const config = ADOConfig.getFromForm({});

            // Validation
            if (!currentPRId) {
                showNoPRError();
                return;
            }

            if (!ADOConfig.isValid(config) || !config.repository) {
                ADOUI.showError('results', 'Please fill in all fields. Missing fields can be configured in Settings or in Advanced Configuration below.');
                document.getElementById('configSection').style.display = 'block';
                return;
            }

            // Save configuration
            ADOConfig.save(config);

            ADOUI.showLoading('results', 'Loading PR threads...');

            try {
                // Fetch PR details, threads, and iterations in parallel
                const [prData, threadsData, iterationsData] = await Promise.all([
                    ADOAPI.getPR(config, currentPRId),
                    ADOAPI.getPRThreads(config, currentPRId),
                    ADOAPI.getPRIterations(config, currentPRId)
                ]);

                allThreads = threadsData.value || [];
                allIterations = iterationsData.value || [];
                currentPRData = prData;
                currentConfig = config;

                // Debug: Log unique status values found in threads
                const uniqueStatuses = new Set(allThreads.map(t => t.status));
                console.log('Loaded threads. Unique status values found:', Array.from(uniqueStatuses));
                console.log('Sample threads with their statuses:', allThreads.slice(0, 5).map(t => ({ id: t.id, status: t.status })));

                // Collect and resolve identities
                await ADOIdentity.collectAndResolveFromThreads(allThreads, config.serverUrl, config.organization, config.pat);

                // Show filters
                document.getElementById('threadFilters').style.display = 'block';

                // Populate author filter
                populateAuthorFilter();

                // Restore filters from URL (if any) and apply
                restoreFiltersFromURL();

            } catch (error) {
                ADOUI.showError('results', error.message);
            }
        }

        function populateAuthorFilter() {
            const authorFilter = document.getElementById('threadAuthorFilter');
            const authors = new Set();

            allThreads.forEach(thread => {
                if (thread.comments && thread.comments.length > 0) {
                    const firstComment = thread.comments[0];
                    if (firstComment.author && firstComment.author.displayName) {
                        authors.add(firstComment.author.displayName);
                    }
                }
            });

            let html = '<option value="">All authors</option>';
            Array.from(authors).sort().forEach(author => {
                html += `<option value="${ADOContent.escapeHtml(author)}">${ADOContent.escapeHtml(author)}</option>`;
            });

            authorFilter.innerHTML = html;
        }

        function applyThreadFilters() {
            const showDeleted = document.getElementById('showDeleted').checked;
            const selectedStatuses = getSelectedThreadStatuses();
            const selectedAuthor = document.getElementById('threadAuthorFilter').value;

            const filtered = allThreads.filter(thread => {
                // Deleted filter
                if (!showDeleted && thread.isDeleted === true) {
                    return false;
                }

                // Status filter
                // Distinguish between undefined (no status) and "unknown" (actual status value)
                if (selectedStatuses.length > 0) {
                    if (thread.status === undefined) {
                        // Thread has no status field
                        if (!selectedStatuses.includes('noStatus')) {
                            return false;
                        }
                    } else {
                        // Thread has a status field
                        const status = thread.status.toLowerCase();
                        if (!selectedStatuses.includes(status)) {
                            return false;
                        }
                    }
                }

                // Author filter (first comment author)
                if (selectedAuthor) {
                    if (!thread.comments || thread.comments.length === 0) {
                        return false;
                    }
                    const firstComment = thread.comments[0];
                    if (!firstComment.author || firstComment.author.displayName !== selectedAuthor) {
                        return false;
                    }
                }

                return true;
            });

            // Update counts
            document.getElementById('totalCount').textContent = allThreads.length;
            document.getElementById('filteredCount').textContent = filtered.length;

            // Display filtered threads
            displayResults(currentPRData, filtered, allIterations, currentConfig);

            // Update URL with current filter state
            updateURL();
        }

        function toggleStatusChip(button) {
            button.classList.toggle('selected');
            applyThreadFilters();
        }

        function getSelectedThreadStatuses() {
            const selectedChips = document.querySelectorAll('.thread-filters .status-chip.selected');
            return Array.from(selectedChips).map(chip => {
                const status = chip.dataset.status;
                // Keep 'noStatus' in camelCase, lowercase everything else
                return status === 'noStatus' ? status : status.toLowerCase();
            });
        }

        function toggleView() {
            isCompactView = !isCompactView;
            const button = document.getElementById('viewToggle');
            button.textContent = isCompactView ? 'Switch to Detailed' : 'Switch to Compact';

            // Re-apply filters to refresh display
            applyThreadFilters();
        }

        function toggleBulkMode() {
            isBulkMode = !isBulkMode;
            selectedThreadIds.clear();

            const button = document.getElementById('bulkModeToggle');
            const bulkActions = document.getElementById('bulkActions');
            const filters = document.querySelectorAll('.thread-filters .filter-row');

            if (isBulkMode) {
                button.textContent = 'Disable Bulk Selection';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-primary');
                bulkActions.classList.add('show');

                // Disable filters in bulk mode
                filters.forEach(row => {
                    const inputs = row.querySelectorAll('input, select');
                    inputs.forEach(input => input.disabled = true);
                });
            } else {
                button.textContent = 'Enable Bulk Selection';
                button.classList.remove('btn-primary');
                button.classList.add('btn-secondary');
                bulkActions.classList.remove('show');

                // Enable filters
                filters.forEach(row => {
                    const inputs = row.querySelectorAll('input, select');
                    inputs.forEach(input => input.disabled = false);
                });
            }

            // Refresh display to show/hide checkboxes
            applyThreadFilters();
        }

        function toggleThreadSelection(threadId) {
            if (selectedThreadIds.has(threadId)) {
                selectedThreadIds.delete(threadId);
            } else {
                selectedThreadIds.add(threadId);
            }

            // Update selected count
            document.getElementById('selectedCount').textContent = selectedThreadIds.size;

            // Update checkbox state
            const checkbox = document.getElementById(`thread-checkbox-${threadId}`);
            if (checkbox) {
                checkbox.checked = selectedThreadIds.has(threadId);
            }
        }

        function selectAllThreads() {
            selectedThreadIds.clear();

            // Get all visible thread IDs
            const checkboxes = document.querySelectorAll('.thread-checkbox');
            checkboxes.forEach(checkbox => {
                const threadId = checkbox.dataset.threadId;
                selectedThreadIds.add(threadId);
                checkbox.checked = true;
            });

            document.getElementById('selectedCount').textContent = selectedThreadIds.size;
        }

        function deselectAllThreads() {
            selectedThreadIds.clear();

            const checkboxes = document.querySelectorAll('.thread-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            document.getElementById('selectedCount').textContent = 0;
        }

        async function changeThreadStatus(threadId, newStatus) {
            if (!currentConfig || !currentPRId || !newStatus) return;

            try {
                console.log(`Attempting to change thread ${threadId} status to: ${newStatus}`);
                const updatedThread = await ADOAPI.updateThreadStatus(currentConfig, currentPRId, threadId, newStatus);
                console.log(`API returned status:`, updatedThread.status);
                console.log(`Full updated thread:`, updatedThread);

                // Update local thread data with response from API
                // Note: threadId from onclick is a string, but thread.id is a number
                const thread = allThreads.find(t => t.id == threadId);
                if (thread && updatedThread) {
                    const oldStatus = thread.status;
                    thread.status = updatedThread.status;
                    thread.properties = updatedThread.properties;
                    console.log(`Updated local thread from ${oldStatus} to ${thread.status}`);
                } else {
                    console.warn(`Could not find thread ${threadId} in allThreads to update locally`);
                }

                // Refresh display to show updated badge
                applyThreadFilters();

                return true;
            } catch (error) {
                console.error(`Failed to update thread status:`, error);
                alert(`Failed to update thread status: ${error.message}\n\nNote: This requires a PAT with "Code (Write)" permissions.`);
                return false;
            }
        }

        async function removeThreadStatus(threadId) {
            if (!currentConfig || !currentPRId) return;

            const confirmed = confirm('Are you sure you want to remove the status from this thread?');
            if (!confirmed) return;

            try {
                console.log(`Attempting to remove status from thread ${threadId}`);
                const updatedThread = await ADOAPI.removeThreadStatus(currentConfig, currentPRId, threadId);
                console.log(`API returned after removing status:`, updatedThread);

                // Update local thread data with response from API
                // Note: threadId from onclick is a string, but thread.id is a number
                const thread = allThreads.find(t => t.id == threadId);
                if (thread && updatedThread) {
                    thread.status = updatedThread.status;
                    thread.properties = updatedThread.properties;
                    console.log(`Removed status from thread, new status:`, thread.status);
                } else {
                    console.warn(`Could not find thread ${threadId} in allThreads to update locally`);
                }

                // Refresh display
                applyThreadFilters();

                return true;
            } catch (error) {
                console.error(`Failed to remove thread status:`, error);
                alert(`Failed to remove thread status: ${error.message}\n\nNote: This requires a PAT with "Code (Write)" permissions.`);
                return false;
            }
        }

        async function applyBulkStatusChange() {
            const newStatus = document.getElementById('bulkStatusSelect').value;

            if (!newStatus) {
                alert('Please select a status to apply.');
                return;
            }

            if (selectedThreadIds.size === 0) {
                alert('Please select at least one thread.');
                return;
            }

            const statusLabels = {
                'active': 'Active',
                'fixed': 'Resolved',
                'closed': 'Closed',
                'wontFix': "Won't Fix",
                'pending': 'Pending'
            };
            const statusLabel = statusLabels[newStatus] || newStatus;

            const confirmed = confirm(`Are you sure you want to change ${selectedThreadIds.size} thread(s) to "${statusLabel}"?`);
            if (!confirmed) return;

            ADOUI.showLoading('results', `Updating ${selectedThreadIds.size} thread(s)...`);

            let successCount = 0;
            let failCount = 0;

            for (const threadId of selectedThreadIds) {
                const success = await changeThreadStatus(threadId, newStatus);
                if (success) {
                    successCount++;
                } else {
                    failCount++;
                }
            }

            // Clear selection and refresh
            selectedThreadIds.clear();
            document.getElementById('selectedCount').textContent = 0;
            document.getElementById('bulkStatusSelect').value = '';

            applyThreadFilters();

            if (failCount === 0) {
                alert(`Successfully updated ${successCount} thread(s).`);
            } else {
                alert(`Updated ${successCount} thread(s) successfully.\n${failCount} thread(s) failed to update.`);
            }
        }

        function getIterationLinksForComment(comment, thread, iterations, config, prData, filePath) {
            const commentId = comment.id;
            const discussionId = thread.id;

            if (!iterations || iterations.length === 0) {
                return { beforeLink: null, afterLink: null, completeLink: null };
            }

            const sortedIterations = [...iterations].sort((a, b) =>
                new Date(a.createdDate) - new Date(b.createdDate)
            );

            const commentTime = new Date(comment.publishedDate);

            // Find last iteration before comment
            let lastBeforeIndex = -1;
            for (let i = sortedIterations.length - 1; i >= 0; i--) {
                if (new Date(sortedIterations[i].createdDate) < commentTime) {
                    lastBeforeIndex = i;
                    break;
                }
            }

            // Find first iteration after comment
            let firstAfterIndex = -1;
            for (let i = 0; i < sortedIterations.length; i++) {
                if (new Date(sortedIterations[i].createdDate) > commentTime) {
                    firstAfterIndex = i;
                    break;
                }
            }

            const latestIteration = sortedIterations[sortedIterations.length - 1];

            let beforeLink = null;
            let afterLink = null;
            let completeLink = null;

            const baseUrl = `${config.serverUrl}/${config.organization}/${config.project}/_git/${config.repository}/pullrequest/${prData.pullRequestId}`;
            const pathParam = filePath ? `&path=${encodeURIComponent(filePath)}` : '';
            const commentParams = `&discussionId=${discussionId}&commentId=${commentId}`;

            if (lastBeforeIndex >= 0) {
                const baseIteration = 0;
                const targetIteration = sortedIterations[lastBeforeIndex].id;
                beforeLink = `${baseUrl}?_a=files${pathParam}&iteration=${targetIteration}&base=${baseIteration}${commentParams}`;
            }

            if (firstAfterIndex >= 0) {
                const baseIteration = sortedIterations[firstAfterIndex].id - 1;
                const targetIteration = latestIteration.id;
                afterLink = `${baseUrl}?_a=files${pathParam}&iteration=${targetIteration}&base=${baseIteration}${commentParams}`;
            }

            const baseIteration = 0;
            const targetIteration = latestIteration.id;
            completeLink = `${baseUrl}?_a=files${pathParam}&iteration=${targetIteration}&base=${baseIteration}${commentParams}`;

            return { beforeLink, afterLink, completeLink };
        }

        async function toggleFilePreview(threadId, filePath, startLine, endLine, firstIterationId, secondIterationId) {
            const previewDiv = document.getElementById(`file-preview-${threadId}`);
            const headerDiv = previewDiv.previousElementSibling;
            const arrow = headerDiv.querySelector('span:first-child');
            const label = headerDiv.querySelector('span:last-child');

            if (previewDiv.classList.contains('show')) {
                // Collapse
                previewDiv.classList.remove('show');
                arrow.textContent = '‚ñ∂';
                // Keep the label as is when collapsed
            } else {
                // Expand
                previewDiv.classList.add('show');
                arrow.textContent = '‚ñº';

                // Load content if not already loaded
                if (!previewDiv.hasAttribute('data-loaded')) {
                    previewDiv.innerHTML = '<div style="padding: 12px; color: #858585;">Loading...</div>';

                    try {
                        // Use the iteration context to get the correct file version
                        // secondComparingIteration is the iteration where the comment was made (the "right" side of the diff)
                        // firstComparingIteration is the base iteration (the "left" side of the diff)
                        let commitId;
                        let iteration;

                        console.log(`Loading file preview for thread ${threadId}:`, {
                            firstIterationId,
                            secondIterationId,
                            totalIterations: allIterations.length
                        });

                        // Use secondComparingIteration (the target/right side) as it represents the state when the comment was made
                        if (secondIterationId !== null && secondIterationId !== undefined) {
                            // Find the iteration by ID
                            iteration = allIterations.find(it => it.id === secondIterationId);
                            console.log(`Using secondIterationId ${secondIterationId}, found:`, iteration?.id);
                        } else if (firstIterationId !== null && firstIterationId !== undefined) {
                            // Fallback to firstIterationId if secondIterationId is not available
                            iteration = allIterations.find(it => it.id === firstIterationId);
                            console.log(`Using firstIterationId ${firstIterationId}, found:`, iteration?.id);
                        }

                        if (!iteration) {
                            // Last resort: use latest iteration
                            iteration = allIterations[allIterations.length - 1];
                            console.log('Using latest iteration as fallback:', iteration?.id);
                        }

                        commitId = iteration?.sourceRefCommit?.commitId || currentPRData.lastMergeSourceCommit?.commitId;
                        console.log(`Using commit ID: ${commitId}`);

                        if (!commitId) {
                            throw new Error('Could not determine commit version');
                        }

                        const fileContent = await ADOAPI.getFileContent(currentConfig, filePath, {
                            version: commitId,
                            versionType: 'commit'
                        });

                        // Split into lines and show context around the referenced lines
                        const lines = fileContent.split('\n');
                        const contextLines = 5; // Show 5 lines before and after
                        const startIdx = Math.max(0, startLine - contextLines - 1);
                        const endIdx = Math.min(lines.length, endLine + contextLines);

                        let html = '<pre>';
                        for (let i = startIdx; i < endIdx; i++) {
                            const lineNum = i + 1;
                            const lineContent = ADOContent.escapeHtml(lines[i] || '');
                            const isHighlighted = lineNum >= startLine && lineNum <= endLine;
                            const highlightClass = isHighlighted ? ' highlight' : '';

                            html += `<div class="file-preview-line${highlightClass}"><span class="file-preview-line-number">${lineNum}</span><span class="file-preview-line-content">${lineContent}</span></div>`;
                        }
                        html += '</pre>';

                        previewDiv.innerHTML = html;
                        previewDiv.setAttribute('data-loaded', 'true');
                    } catch (error) {
                        console.error('Failed to load file preview:', error);
                        previewDiv.innerHTML = `<div style="padding: 12px; color: #a4262c;">Failed to load file preview: ${ADOContent.escapeHtml(error.message)}</div>`;
                    }
                }
            }
        }

        function displayResults(prData, threads, iterations, config) {
            const resultsDiv = document.getElementById('results');

            // Count threads by status
            const statusCounts = threads.reduce((acc, thread) => {
                if (thread.isDeleted === true) {
                    acc.deleted = (acc.deleted || 0) + 1;
                } else if (thread.status === undefined) {
                    // Thread has no status field
                    acc.noStatus = (acc.noStatus || 0) + 1;
                } else {
                    // Thread has a status field (including "unknown" as a valid value)
                    const status = thread.status;
                    acc[status] = (acc[status] || 0) + 1;
                }
                return acc;
            }, {});

            const prUrl = `${config.serverUrl}/${config.organization}/${config.project}/_git/${config.repository}/pullrequest/${prData.pullRequestId}`;
            const draftBadge = prData.isDraft ? ' <span class="badge badge-draft">DRAFT</span>' : '';

            let html = `
                <div class="pr-info">
                    <h2>
                        PR #${prData.pullRequestId}: ${ADOContent.escapeHtml(prData.title)}
                        <a href="${prUrl}" target="_blank" style="font-size: 16px; margin-left: 10px; color: #0078d4; text-decoration: none;" title="Open PR in Azure DevOps">üîó View in ADO</a>
                    </h2>
                    <p><strong>Author:</strong> ${ADOContent.escapeHtml(prData.createdBy.displayName)}</p>
                    <p><strong>Status:</strong> ${prData.status}${draftBadge}</p>
                    <p><strong>Created:</strong> ${ADOUI.formatDate(prData.creationDate)}</p>
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #0078d4; font-weight: 600;">üì° API Endpoints Used</summary>
                        <div style="margin-top: 10px; font-size: 13px; font-family: monospace; background: #f8f8f8; padding: 10px; border-radius: 4px;">
                            <div style="margin-bottom: 8px;">
                                <strong>PR Details:</strong><br>
                                <code>${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}?api-version=6.0</code>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>PR Threads:</strong><br>
                                <code>${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}/threads?api-version=6.0</code>
                            </div>
                            <div>
                                <strong>PR Iterations:</strong><br>
                                <code>${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}/iterations?api-version=6.0</code>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-value">${threads.length}</div>
                        <div class="stat-label">Total Threads</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${statusCounts.active || 0}</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${statusCounts.fixed || 0}</div>
                        <div class="stat-label">Fixed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${statusCounts.closed || 0}</div>
                        <div class="stat-label">Closed</div>
                    </div>
                    ${statusCounts.deleted ? `
                    <div class="stat">
                        <div class="stat-value" style="color: #a4262c;">${statusCounts.deleted}</div>
                        <div class="stat-label">Deleted</div>
                    </div>
                    ` : ''}
                </div>
            `;

            if (threads.length === 0) {
                html += '<div class="info">No threads found for this Pull Request.</div>';
            } else {
                html += '<div class="thread-container">';

                threads.forEach((thread, index) => {
                    const hasStatus = thread.status !== undefined;
                    const status = thread.status; // Keep actual status value (could be undefined, 'unknown', 'active', etc.)
                    const isThreadDeleted = thread.isDeleted === true;

                    const statusClass = ADOUI.getStatusBadgeClass(status, isThreadDeleted);
                    const statusText = ADOUI.getStatusText(status, isThreadDeleted);

                    const threadId = thread.id;
                    const threadUrl = ADOURL.buildThreadUrl(config, prData.pullRequestId, threadId, thread.threadContext?.filePath);
                    const apiEndpoint = `${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}/threads/${threadId}?api-version=6.0`;

                    const compactClass = isCompactView ? 'compact-view' : '';
                    const isChecked = selectedThreadIds.has(threadId) ? 'checked' : '';

                    // Build status dropdown (only when not in bulk mode and not deleted)
                    let statusControl = '';
                    if (!isBulkMode && !isThreadDeleted) {
                        if (hasStatus) {
                            // Thread has status: show "Change status:" with current selection and remove button
                            statusControl = `
                                <span class="thread-status-change">
                                    <select onchange="changeThreadStatus('${threadId}', this.value); this.blur();">
                                        <option value="">Change status...</option>
                                        <option value="active" ${status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="fixed" ${status === 'fixed' ? 'selected' : ''}>Resolved</option>
                                        <option value="closed" ${status === 'closed' ? 'selected' : ''}>Closed</option>
                                        <option value="wontFix" ${status === 'wontFix' ? 'selected' : ''}>Won't Fix</option>
                                        <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="unknown" ${status === 'unknown' ? 'selected' : ''}>Unknown</option>
                                    </select>
                                    <button onclick="removeThreadStatus('${threadId}')" class="btn-secondary" style="margin-left: 5px; padding: 2px 8px; font-size: 12px;" title="Remove status from this thread">‚úï</button>
                                </span>
                            `;
                        } else {
                            // Thread has no status: show "Try force status:" with no selection
                            statusControl = `
                                <span class="thread-status-change">
                                    <select onchange="changeThreadStatus('${threadId}', this.value); this.blur();">
                                        <option value="" selected>Try force status...</option>
                                        <option value="active">Active</option>
                                        <option value="fixed">Resolved</option>
                                        <option value="closed">Closed</option>
                                        <option value="wontFix">Won't Fix</option>
                                        <option value="pending">Pending</option>
                                        <option value="unknown">Unknown</option>
                                    </select>
                                </span>
                            `;
                        }
                    }

                    html += `
                        <div class="thread ${compactClass}">
                            <div class="thread-header">
                                <span>
                                    ${isBulkMode ? `<input type="checkbox" class="thread-checkbox" id="thread-checkbox-${threadId}" data-thread-id="${threadId}" ${isChecked} onchange="toggleThreadSelection('${threadId}')">` : ''}
                                    Thread #${index + 1}
                                    <a href="${threadUrl}" target="_blank" style="font-size: 13px; margin-left: 8px; color: #0078d4; text-decoration: none;" title="Open thread in Azure DevOps (${thread.threadContext ? 'files tab' : 'overview tab'})">üîó</a>
                                </span>
                                <span>
                                    <button class="raw-json-toggle" onclick="ADOUI.toggleRawJson('thread-${index}')">View Raw JSON</button>
                                    ${hasStatus ? `<span class="badge ${statusClass}">${statusText}</span>` : ''}
                                    ${statusControl}
                                </span>
                            </div>
                    `;

                    // Add raw JSON container
                    const jsonString = JSON.stringify(thread, null, 2);
                    html += `
                        <div id="thread-${index}" class="raw-json-container">
                            <div style="margin-bottom: 10px; color: #9cdcfe;">
                                <strong>API Endpoint:</strong><br>
                                <a href="${apiEndpoint}" target="_blank" class="api-link" title="Open in new tab (requires authentication)">${apiEndpoint}</a>
                            </div>
                            <pre>${ADOContent.escapeHtml(jsonString)}</pre>
                        </div>
                    `;

                    // Show thread context if it's a code comment
                    // threadContext has file path and line info
                    // pullRequestThreadContext has iteration context
                    if (thread.threadContext) {
                        const ctx = thread.threadContext;
                        const lineInfo = ctx.rightFileStart ? ` (Line ${ctx.rightFileStart.line}${ctx.rightFileEnd && ctx.rightFileEnd.line !== ctx.rightFileStart.line ? `-${ctx.rightFileEnd.line}` : ''})` : '';

                        // If we have line information, make the file path a collapsible preview header
                        if (ctx.filePath && ctx.rightFileStart) {
                            const iterationId = thread.pullRequestThreadContext?.iterationContext?.firstComparingIteration;
                            const secondIterationId = thread.pullRequestThreadContext?.iterationContext?.secondComparingIteration;

                            // Log iteration context for debugging
                            console.log(`Thread ${threadId} iteration context:`, {
                                firstComparingIteration: iterationId,
                                secondComparingIteration: secondIterationId,
                                fullContext: thread.pullRequestThreadContext?.iterationContext
                            });

                            html += `
                                <div class="file-preview">
                                    <div class="file-preview-header" onclick="toggleFilePreview('${threadId}', '${ADOContent.escapeHtml(ctx.filePath)}', ${ctx.rightFileStart.line}, ${ctx.rightFileEnd ? ctx.rightFileEnd.line : ctx.rightFileStart.line}, ${iterationId !== undefined ? iterationId : 'null'}, ${secondIterationId !== undefined ? secondIterationId : 'null'})">
                                        <span>‚ñ∂</span>
                                        <span><strong>File:</strong> ${ADOContent.escapeHtml(ctx.filePath || 'N/A')}${lineInfo} - Click to show file preview</span>
                                    </div>
                                    <div id="file-preview-${threadId}" class="file-preview-content"></div>
                                </div>
                            `;
                        } else {
                            // No line information, just show as regular context
                            html += `
                                <div class="thread-context">
                                    <strong>File:</strong> ${ADOContent.escapeHtml(ctx.filePath || 'N/A')}${lineInfo}
                                </div>
                            `;
                        }
                    }

                    // Show all comments in the thread
                    if (thread.comments && thread.comments.length > 0) {
                        thread.comments.forEach(comment => {
                            let resolvedContent = ADOContent.processContent(comment.content);

                            // Check if content is essentially empty (just whitespace or empty code blocks)
                            const contentStripped = resolvedContent.replace(/<pre><code><\/code><\/pre>/g, '').trim();
                            const hasRealContent = contentStripped.length > 0;

                            // Get iteration links for this comment
                            const filePath = thread.threadContext?.filePath || null;
                            const iterationLinks = getIterationLinksForComment(
                                comment,
                                thread,
                                iterations,
                                config,
                                prData,
                                filePath
                            );

                            // Check if comment is deleted
                            const isDeleted = comment.isDeleted === true;

                            // Determine comment type
                            const commentType = comment.commentType || 'unknown';
                            let commentTypeLabel = '';
                            let commentClass = '';
                            let commentTypeBadgeClass = '';

                            if (isDeleted) {
                                commentTypeLabel = 'Deleted';
                                commentTypeBadgeClass = 'comment-type-deleted';
                            } else {
                                switch(commentType) {
                                    case 'system':
                                    case 3:
                                        commentTypeLabel = 'System';
                                        commentClass = 'system-comment';
                                        commentTypeBadgeClass = 'comment-type-system';
                                        break;
                                    case 'codeChange':
                                    case 2:
                                        commentTypeLabel = 'Code Change';
                                        commentClass = 'code-change-comment';
                                        commentTypeBadgeClass = 'comment-type-code-change';
                                        break;
                                    case 'text':
                                    case 1:
                                        commentTypeLabel = 'Text';
                                        commentTypeBadgeClass = 'comment-type-text';
                                        break;
                                    default:
                                        commentTypeLabel = 'Unknown';
                                        break;
                                }
                            }

                            html += `
                                <div class="comment ${commentClass}">
                                    <div class="comment-header">
                                        <span>
                                            <span class="comment-author">${ADOContent.escapeHtml(comment.author?.displayName || 'Unknown')}</span>
                                            ${isDeleted || commentTypeLabel !== 'Text' ? `<span class="comment-type-badge ${commentTypeBadgeClass}">${commentTypeLabel}</span>` : ''}
                                        </span>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span class="comment-date">${ADOUI.formatDate(comment.publishedDate)}</span>
                                            ${iterationLinks.completeLink ? `
                                            <div class="code-links">
                                                ${iterationLinks.beforeLink ? `<a href="${iterationLinks.beforeLink}" target="_blank" class="comment-link" title="Diff from first update to last update before this comment">‚Üê</a>` : ''}
                                                ${iterationLinks.afterLink ? `<a href="${iterationLinks.afterLink}" target="_blank" class="comment-link" title="Diff from first update after this comment to latest">‚Üí</a>` : ''}
                                                <a href="${iterationLinks.completeLink}" target="_blank" class="comment-link" title="Complete diff from first to latest update">‚Üî</a>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${hasRealContent ? `<div class="comment-content">${resolvedContent}</div>` : ''}

                                    ${(commentType === 'codeChange' || commentType === 2) && thread.threadContext?.leftFileStart && thread.threadContext?.rightFileStart ? `
                                    <div style="background: #1e1e1e; color: #d4d4d4; padding: 12px; margin-top: 8px; border-radius: 4px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 12px;">
                                        <div style="color: #ce9178; margin-bottom: 8px;">üí° Code change suggestion</div>
                                        <div style="color: #d4d4d4; margin-bottom: 8px;">Suggested changes to lines ${thread.threadContext.leftFileStart.line}${thread.threadContext.leftFileEnd ? `-${thread.threadContext.leftFileEnd.line}` : ''} ‚Üí ${thread.threadContext.rightFileStart.line}${thread.threadContext.rightFileEnd ? `-${thread.threadContext.rightFileEnd.line}` : ''}</div>
                                        <div style="color: #858585; font-size: 11px;">üí° Tip: Click the iteration links (‚Üê, ‚Üí, ‚Üî) above or "View in ADO" to see the actual code diff and suggestion details.</div>
                                    </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                    }

                    html += '</div>';
                });

                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
