<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure DevOps PR Threads Viewer</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .pr-info {
            background: #f3f2f1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .thread-container {
            margin-bottom: 30px;
        }

        .thread {
            border: 1px solid #edebe9;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .thread-header {
            background: #f3f2f1;
            padding: 15px;
            font-weight: 600;
            color: #323130;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment {
            padding: 12px 15px;
            border-bottom: 1px solid #edebe9;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment.system-comment {
            background: #f8f8f8;
            border-left: 3px solid #a19f9d;
        }

        .comment.code-change-comment {
            background: #fff9e6;
            border-left: 3px solid #ffb900;
        }

        .comment-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .comment-type-system {
            background: #e1dfdd;
            color: #605e5c;
        }

        .comment-type-code-change {
            background: #fff4ce;
            color: #8a6d3b;
        }

        .comment-type-text {
            background: #e1f3ff;
            color: #004578;
        }

        .comment-type-deleted {
            background: #fde7e9;
            color: #a4262c;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #0078d4;
        }

        .comment-date {
            color: #605e5c;
            font-size: 13px;
        }

        .comment-link {
            color: #0078d4;
            text-decoration: none;
            font-size: 13px;
            margin-left: 10px;
        }

        .comment-link:hover {
            text-decoration: underline;
        }

        .comment-content {
            color: #323130;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .comment-content strong {
            font-weight: 700;
            color: #323130;
        }

        .comment-content em {
            font-style: italic;
            color: #323130;
        }

        .comment-content a {
            color: #0078d4;
            text-decoration: none;
        }

        .comment-content a:hover {
            text-decoration: underline;
        }

        .comment-content img {
            max-width: 100%;
            height: auto;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            margin: 5px 5px 5px 0;
            display: inline-block;
            vertical-align: middle;
        }

        .thread-context {
            background: #fff4ce;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #ffb900;
            font-size: 13px;
        }

        .api-link {
            color: #0078d4;
            text-decoration: none;
            font-size: 12px;
            font-family: monospace;
            background: #f3f2f1;
            padding: 4px 8px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 5px;
        }

        .api-link:hover {
            background: #e1dfdd;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>üí¨ PR Threads Viewer</h1>
                <p style="color: #605e5c; margin: 0;">View all discussion threads from a Pull Request</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="ado-pr-list.html" style="color: #0078d4; text-decoration: none; font-size: 14px;">üìã PR List</a>
                <a href="index.html" style="color: #0078d4; text-decoration: none; font-size: 14px;">üè† Home</a>
                <a href="ado-settings.html" style="color: #0078d4; text-decoration: none; font-size: 14px;">‚öôÔ∏è Settings</a>
            </div>
        </div>

        <div id="prInfo" style="margin-bottom: 20px;"></div>

        <div class="config-section" id="configSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">Configuration</h3>
            </div>

            <details id="advancedConfig">
                <summary style="cursor: pointer; color: #0078d4; font-weight: 600;">üîß Advanced Configuration</summary>
                <div style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="serverUrl">Azure DevOps Server URL</label>
                        <input type="text" id="serverUrl" placeholder="https://your-ado-server.com" />
                    </div>
                    <div class="form-group">
                        <label for="organization">Organization/Collection</label>
                        <input type="text" id="organization" placeholder="DefaultCollection" />
                    </div>
                    <div class="form-group">
                        <label for="project">Project Name</label>
                        <input type="text" id="project" placeholder="MyProject" />
                    </div>
                    <div class="form-group">
                        <label for="repository">Repository Name</label>
                        <input type="text" id="repository" placeholder="MyRepo" />
                    </div>
                    <div class="form-group">
                        <label for="pat">Personal Access Token (PAT)</label>
                        <input type="password" id="pat" placeholder="Your PAT with Code (Read) permission" />
                    </div>
                </div>
            </details>

            <button id="loadButton" onclick="loadPRThreads()">Load PR Threads</button>
            <div id="configStatus" style="margin-top: 10px; font-size: 12px; color: #605e5c;"></div>
        </div>

        <div id="results"></div>
    </div>

    <script src="common.js"></script>
    <script>
        let currentPRId = null;

        // Parse URL parameters on load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = ADOURL.getParams();
            currentPRId = urlParams.get('prId') || urlParams.get('id');

            // Load saved configuration from localStorage
            const savedConfig = ADOConfig.get();
            if (savedConfig) {
                document.getElementById('serverUrl').value = savedConfig.serverUrl || '';
                document.getElementById('organization').value = savedConfig.organization || '';
                document.getElementById('project').value = savedConfig.project || '';
                document.getElementById('repository').value = savedConfig.repository || '';
                document.getElementById('pat').value = savedConfig.pat || '';
            }

            // Show PR info or error
            if (currentPRId) {
                showPRInfo();

                // Auto-load if config is valid
                if (savedConfig && ADOConfig.isValid(savedConfig) && savedConfig.repository) {
                    setTimeout(() => loadPRThreads(), 100);
                } else {
                    // Show config section if settings are missing
                    document.getElementById('configSection').style.display = 'block';
                    const statusDiv = document.getElementById('configStatus');
                    statusDiv.innerHTML = '‚ö†Ô∏è Some settings are missing. <a href="ado-settings.html" style="color: #0078d4;">Configure in Settings</a> or use Advanced Configuration below.';
                    statusDiv.style.color = '#8a6d3b';
                }
            } else {
                showNoPRError();
            }
        });

        function showPRInfo() {
            const prInfoDiv = document.getElementById('prInfo');
            const config = ADOConfig.get();

            prInfoDiv.innerHTML = `
                <div class="info">
                    <strong>Loading Pull Request #${currentPRId}</strong><br>
                    ${config && config.project && config.repository ?
                        `Project: ${ADOContent.escapeHtml(config.project)} / Repository: ${ADOContent.escapeHtml(config.repository)}` :
                        'Using saved configuration'}
                </div>
            `;
        }

        function showNoPRError() {
            const prInfoDiv = document.getElementById('prInfo');
            prInfoDiv.innerHTML = `
                <div class="warning">
                    <strong>‚ö†Ô∏è No Pull Request specified</strong><br>
                    Please navigate from the <a href="ado-pr-list.html" style="color: #0078d4; font-weight: 600;">PR List page</a>
                    or provide a PR ID in the URL (e.g., ?prId=123).
                </div>
            `;
        }

        async function loadPRThreads() {
            const config = ADOConfig.getFromForm({});

            // Validation
            if (!currentPRId) {
                showNoPRError();
                return;
            }

            if (!ADOConfig.isValid(config) || !config.repository) {
                ADOUI.showError('results', 'Please fill in all fields. Missing fields can be configured in Settings or in Advanced Configuration below.');
                document.getElementById('configSection').style.display = 'block';
                return;
            }

            // Save configuration
            ADOConfig.save(config);

            ADOUI.showLoading('results', 'Loading PR threads...');

            try {
                // Fetch PR details, threads, and iterations in parallel
                const [prData, threadsData, iterationsData] = await Promise.all([
                    ADOAPI.getPR(config, currentPRId),
                    ADOAPI.getPRThreads(config, currentPRId),
                    ADOAPI.getPRIterations(config, currentPRId)
                ]);

                const threads = threadsData.value || [];
                const iterations = iterationsData.value || [];

                // Collect and resolve identities
                await ADOIdentity.collectAndResolveFromThreads(threads, config.serverUrl, config.organization, config.pat);

                displayResults(prData, threads, iterations, config);

            } catch (error) {
                ADOUI.showError('results', error.message);
            }
        }

        function getIterationLinksForComment(comment, thread, iterations, config, prData, filePath) {
            const commentId = comment.id;
            const discussionId = thread.id;

            if (!iterations || iterations.length === 0) {
                return { beforeLink: null, afterLink: null, completeLink: null };
            }

            const sortedIterations = [...iterations].sort((a, b) =>
                new Date(a.createdDate) - new Date(b.createdDate)
            );

            const commentTime = new Date(comment.publishedDate);

            // Find last iteration before comment
            let lastBeforeIndex = -1;
            for (let i = sortedIterations.length - 1; i >= 0; i--) {
                if (new Date(sortedIterations[i].createdDate) < commentTime) {
                    lastBeforeIndex = i;
                    break;
                }
            }

            // Find first iteration after comment
            let firstAfterIndex = -1;
            for (let i = 0; i < sortedIterations.length; i++) {
                if (new Date(sortedIterations[i].createdDate) > commentTime) {
                    firstAfterIndex = i;
                    break;
                }
            }

            const latestIteration = sortedIterations[sortedIterations.length - 1];

            let beforeLink = null;
            let afterLink = null;
            let completeLink = null;

            const baseUrl = `${config.serverUrl}/${config.organization}/${config.project}/_git/${config.repository}/pullrequest/${prData.pullRequestId}`;
            const pathParam = filePath ? `&path=${encodeURIComponent(filePath)}` : '';
            const commentParams = `&discussionId=${discussionId}&commentId=${commentId}`;

            if (lastBeforeIndex >= 0) {
                const baseIteration = 0;
                const targetIteration = sortedIterations[lastBeforeIndex].id;
                beforeLink = `${baseUrl}?_a=files${pathParam}&iteration=${targetIteration}&base=${baseIteration}${commentParams}`;
            }

            if (firstAfterIndex >= 0) {
                const baseIteration = sortedIterations[firstAfterIndex].id - 1;
                const targetIteration = latestIteration.id;
                afterLink = `${baseUrl}?_a=files${pathParam}&iteration=${targetIteration}&base=${baseIteration}${commentParams}`;
            }

            const baseIteration = 0;
            const targetIteration = latestIteration.id;
            completeLink = `${baseUrl}?_a=files${pathParam}&iteration=${targetIteration}&base=${baseIteration}${commentParams}`;

            return { beforeLink, afterLink, completeLink };
        }

        function displayResults(prData, threads, iterations, config) {
            const resultsDiv = document.getElementById('results');

            // Count threads by status
            const statusCounts = threads.reduce((acc, thread) => {
                if (thread.isDeleted === true) {
                    acc.deleted = (acc.deleted || 0) + 1;
                } else {
                    const status = thread.status || 'unknown';
                    acc[status] = (acc[status] || 0) + 1;
                }
                return acc;
            }, {});

            let html = `
                <div class="pr-info">
                    <h2>PR #${prData.pullRequestId}: ${ADOContent.escapeHtml(prData.title)}</h2>
                    <p><strong>Author:</strong> ${ADOContent.escapeHtml(prData.createdBy.displayName)}</p>
                    <p><strong>Status:</strong> ${prData.status}</p>
                    <p><strong>Created:</strong> ${ADOUI.formatDate(prData.creationDate)}</p>
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; color: #0078d4; font-weight: 600;">üì° API Endpoints Used</summary>
                        <div style="margin-top: 10px; font-size: 13px; font-family: monospace; background: #f8f8f8; padding: 10px; border-radius: 4px;">
                            <div style="margin-bottom: 8px;">
                                <strong>PR Details:</strong><br>
                                <code>${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}?api-version=6.0</code>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>PR Threads:</strong><br>
                                <code>${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}/threads?api-version=6.0</code>
                            </div>
                            <div>
                                <strong>PR Iterations:</strong><br>
                                <code>${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}/iterations?api-version=6.0</code>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="stats">
                    <div class="stat">
                        <div class="stat-value">${threads.length}</div>
                        <div class="stat-label">Total Threads</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${statusCounts.active || 0}</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${statusCounts.fixed || 0}</div>
                        <div class="stat-label">Fixed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${statusCounts.closed || 0}</div>
                        <div class="stat-label">Closed</div>
                    </div>
                    ${statusCounts.deleted ? `
                    <div class="stat">
                        <div class="stat-value" style="color: #a4262c;">${statusCounts.deleted}</div>
                        <div class="stat-label">Deleted</div>
                    </div>
                    ` : ''}
                </div>
            `;

            if (threads.length === 0) {
                html += '<div class="info">No threads found for this Pull Request.</div>';
            } else {
                html += '<div class="thread-container">';

                threads.forEach((thread, index) => {
                    const status = thread.status || 'unknown';
                    const isThreadDeleted = thread.isDeleted === true;

                    const statusClass = ADOUI.getStatusBadgeClass(status, isThreadDeleted);
                    const statusText = ADOUI.getStatusText(status, isThreadDeleted);

                    const threadId = thread.id;
                    const threadUrl = ADOURL.buildThreadUrl(config, prData.pullRequestId, threadId, thread.threadContext?.filePath);
                    const apiEndpoint = `${config.serverUrl}/${config.organization}/${config.project}/_apis/git/repositories/${config.repository}/pullRequests/${prData.pullRequestId}/threads/${threadId}?api-version=6.0`;

                    html += `
                        <div class="thread">
                            <div class="thread-header">
                                <span>Thread #${index + 1}</span>
                                <span>
                                    <button class="raw-json-toggle" onclick="ADOUI.toggleRawJson('thread-${index}')">View Raw JSON</button>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </span>
                            </div>
                    `;

                    // Add raw JSON container
                    const jsonString = JSON.stringify(thread, null, 2);
                    html += `
                        <div id="thread-${index}" class="raw-json-container">
                            <div style="margin-bottom: 10px; color: #9cdcfe;">
                                <strong>API Endpoint:</strong><br>
                                <a href="${apiEndpoint}" target="_blank" class="api-link" title="Open in new tab (requires authentication)">${apiEndpoint}</a>
                            </div>
                            <pre>${ADOContent.escapeHtml(jsonString)}</pre>
                        </div>
                    `;

                    // Show thread context if it's a code comment
                    if (thread.threadContext) {
                        const ctx = thread.threadContext;
                        html += `
                            <div class="thread-context">
                                <strong>File:</strong> ${ADOContent.escapeHtml(ctx.filePath || 'N/A')}<br>
                                ${ctx.rightFileStart ? `<strong>Line:</strong> ${ctx.rightFileStart.line}` : ''}
                            </div>
                        `;
                    }

                    // Show all comments in the thread
                    if (thread.comments && thread.comments.length > 0) {
                        thread.comments.forEach(comment => {
                            const resolvedContent = ADOContent.processContent(comment.content);

                            // Get iteration links for this comment
                            const filePath = thread.threadContext?.filePath || null;
                            const iterationLinks = getIterationLinksForComment(
                                comment,
                                thread,
                                iterations,
                                config,
                                prData,
                                filePath
                            );

                            // Check if comment is deleted
                            const isDeleted = comment.isDeleted === true;

                            // Determine comment type
                            const commentType = comment.commentType || 'unknown';
                            let commentTypeLabel = '';
                            let commentClass = '';
                            let commentTypeBadgeClass = '';

                            if (isDeleted) {
                                commentTypeLabel = 'Deleted';
                                commentTypeBadgeClass = 'comment-type-deleted';
                            } else {
                                switch(commentType) {
                                    case 'system':
                                    case 3:
                                        commentTypeLabel = 'System';
                                        commentClass = 'system-comment';
                                        commentTypeBadgeClass = 'comment-type-system';
                                        break;
                                    case 'codeChange':
                                    case 2:
                                        commentTypeLabel = 'Code Change';
                                        commentClass = 'code-change-comment';
                                        commentTypeBadgeClass = 'comment-type-code-change';
                                        break;
                                    case 'text':
                                    case 1:
                                        commentTypeLabel = 'Text';
                                        commentTypeBadgeClass = 'comment-type-text';
                                        break;
                                    default:
                                        commentTypeLabel = 'Unknown';
                                        break;
                                }
                            }

                            html += `
                                <div class="comment ${commentClass}">
                                    <div class="comment-header">
                                        <span>
                                            <span class="comment-author">${ADOContent.escapeHtml(comment.author?.displayName || 'Unknown')}</span>
                                            ${isDeleted || commentTypeLabel !== 'Text' ? `<span class="comment-type-badge ${commentTypeBadgeClass}">${commentTypeLabel}</span>` : ''}
                                        </span>
                                        <span class="comment-date">${ADOUI.formatDate(comment.publishedDate)}</span>
                                    </div>
                                    ${iterationLinks.completeLink ? `
                                    <div style="padding: 8px 0; font-size: 12px; border-bottom: 1px solid #edebe9;">
                                        <strong style="color: #605e5c;">View in Code:</strong>
                                        ${iterationLinks.beforeLink ? `<a href="${iterationLinks.beforeLink}" target="_blank" class="comment-link" title="Diff from first update to last update before this comment">üìã Before</a>` : ''}
                                        ${iterationLinks.afterLink ? `<a href="${iterationLinks.afterLink}" target="_blank" class="comment-link" title="Diff from first update after this comment to latest">üìù After</a>` : ''}
                                        <a href="${iterationLinks.completeLink}" target="_blank" class="comment-link" title="Complete diff from first to latest update">üìÑ Complete</a>
                                    </div>
                                    ` : ''}
                                    ${resolvedContent ? `<div class="comment-content">${resolvedContent}</div>` : ''}
                                </div>
                            `;
                        });
                    }

                    html += '</div>';
                });

                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
